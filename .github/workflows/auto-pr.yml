name: ðŸ”„ Auto Create PR

on:
  push:
    branches:
      - 'feature/**'
      - 'bugfix/**'
      - 'hotfix/**'
      - 'release/**'

jobs:
  auto-pr:
    name: ðŸ”„ Create PR
    runs-on: ubuntu-latest
    if: github.ref != 'refs/heads/main' && github.ref != 'refs/heads/develop'
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: ðŸ“¦ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ” Check if PR exists
        id: check_pr
        run: |
          PR_COUNT=$(gh pr list --head ${{ github.ref_name }} --json number --jq length)
          echo "pr_count=$PR_COUNT" >> $GITHUB_OUTPUT
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ“‹ Setup Node.js
        if: steps.check_pr.outputs.pr_count == '0'
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: ðŸ“¥ Install dependencies
        if: steps.check_pr.outputs.pr_count == '0'
        run: npm ci

      - name: ðŸ§ª Run tests
        if: steps.check_pr.outputs.pr_count == '0'
        run: npm test -- --run

      - name: ðŸ—ï¸ Build check
        if: steps.check_pr.outputs.pr_count == '0'
        run: npm run build

      - name: ðŸ”„ Create Pull Request
        if: steps.check_pr.outputs.pr_count == '0'
        run: |
          # Extract branch type and name
          BRANCH_NAME="${{ github.ref_name }}"
          BRANCH_TYPE=$(echo "$BRANCH_NAME" | cut -d'/' -f1)
          BRANCH_FEATURE=$(echo "$BRANCH_NAME" | cut -d'/' -f2-)
          
          # Determine target branch
          TARGET_BRANCH="main"
          if [[ "$BRANCH_TYPE" == "feature" || "$BRANCH_TYPE" == "bugfix" ]]; then
            TARGET_BRANCH="develop"
          fi
          
          # Create appropriate title and body
          case "$BRANCH_TYPE" in
            "feature")
              TITLE="âœ¨ feat: $BRANCH_FEATURE"
              EMOJI="âœ¨"
              TYPE="Feature"
              ;;
            "bugfix")
              TITLE="ðŸ› fix: $BRANCH_FEATURE"
              EMOJI="ðŸ›"
              TYPE="Bug Fix"
              ;;
            "hotfix")
              TITLE="ðŸš¨ hotfix: $BRANCH_FEATURE"
              EMOJI="ðŸš¨"
              TYPE="Hotfix"
              ;;
            "release")
              TITLE="ðŸš€ release: $BRANCH_FEATURE"
              EMOJI="ðŸš€"
              TYPE="Release"
              ;;
            *)
              TITLE="ðŸ”„ $BRANCH_FEATURE"
              EMOJI="ðŸ”„"
              TYPE="Update"
              ;;
          esac
          
          # Get commit messages for description
          COMMITS=$(git log --oneline $TARGET_BRANCH..HEAD --pretty=format:"- %s" | head -10)
          
          # Create PR body
          cat > pr_body.md << EOF
          ## $EMOJI $TYPE: $BRANCH_FEATURE
          
          ### ðŸ“‹ Description
          This PR introduces changes from the \`$BRANCH_NAME\` branch.
          
          ### ðŸ”„ Changes
          $COMMITS
          
          ### âœ… Checklist
          - [x] ðŸ§ª Tests pass
          - [x] ðŸ—ï¸ Build successful
          - [ ] ðŸ“ Documentation updated
          - [ ] ðŸ” Code reviewed
          - [ ] âœ¨ Ready for merge
          
          ### ðŸš€ Type of Change
          - [ ] ðŸ› Bug fix (non-breaking change which fixes an issue)
          - [ ] âœ¨ New feature (non-breaking change which adds functionality)
          - [ ] ðŸ’¥ Breaking change (fix or feature that would cause existing functionality to not work as expected)
          - [ ] ðŸ“ Documentation update
          - [ ] ðŸ”§ Chore (maintenance, deps update, etc.)
          
          ### ðŸ§ª Testing
          - [x] Unit tests pass
          - [ ] Integration tests pass
          - [ ] Manual testing completed
          
          ---
          
          ðŸ¤– *This PR was automatically created when tests passed on the \`$BRANCH_NAME\` branch.*
          EOF
          
          # Create the PR
          gh pr create \
            --title "$TITLE" \
            --body-file pr_body.md \
            --base "$TARGET_BRANCH" \
            --head "$BRANCH_NAME" \
            --label "auto-created" \
            --label "$BRANCH_TYPE"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸŽ‰ PR Created Successfully
        if: steps.check_pr.outputs.pr_count == '0'
        run: |
          echo "ðŸŽ‰ Pull Request created successfully!"
          echo "ðŸ”— View PR: https://github.com/${{ github.repository }}/pulls"
